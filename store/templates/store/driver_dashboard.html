<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Driver Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #fffdf3, #f6e5a1);
      margin: 0;
      padding: 0;
    }

    .dashboard-container {
      padding: 16px;
    }

    .dashboard-header {
      background: #fff8dc;
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    .user-info {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }

    .profile-pic img {
      border-radius: 50%;
      width: 100px;
      height: 100px;
      object-fit: cover;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .status-badge {
      margin-top: 10px;
      font-weight: bold;
      color: #ffc107;
    }

    .toggle-button {
      margin-top: 16px;
      border: none;
      padding: 10px 20px;
      border-radius: 30px;
      font-weight: bold;
      cursor: pointer;
      color: #fff;
      transition: all 0.3s ease;
      box-shadow: 0 5px 15px rgba(0,0,0,0.15);
    }

    .toggle-button.online {
      background: linear-gradient(to right, #ffcc00, #ffae00);
    }

    .toggle-button.offline {
      background: linear-gradient(to right, #999999, #666666);
    }

    .stats-grid {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-bottom: 20px;
    }

    @media (min-width: 768px) {
      .stats-grid {
        flex-direction: row;
      }
    }

    .stat-card {
      background: #fffdf3;
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.05);
      flex: 1;
    }

    .tables-container {
      background-color: #fffef6;
      padding: 20px;
      border-radius: 20px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
      overflow-x: auto;
      margin-bottom: 30px;
    }

    table {
      min-width: 700px;
    }

    .table th {
      background-color: #fff2b0;
      color: #333;
    }

    .table-striped tbody tr:nth-of-type(odd) {
      background-color: #fffaf0;
    }

    .logout-btn {
      width: 100%;
      max-width: 220px;
      margin: 20px auto;
      display: block;
      background-color: #ff9800;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 10px;
      font-weight: bold;
      box-shadow: 0 5px 15px rgba(255, 152, 0, 0.4);
    }

    .btn-gold {
      background-color: #ffc107;
      color: #212529;
      border: none;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: bold;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .btn-gold:hover {
      background-color: #e0a800;
      color: white;
    }

    .btn-outline-gold {
      border: 1px solid #ffc107;
      color: #ffc107;
      background-color: transparent;
      border-radius: 8px;
    }

    .btn-outline-gold:hover {
      background-color: #ffc107;
      color: white;
    }
  </style>
</head>

<body>
  <div class="dashboard-container">
    <div class="dashboard-header">
      <div class="user-info">
        <div class="profile-pic">
          <img src="{{ driver.profile_picture.url }}" alt="Profile Picture" />
        </div>
        <div class="user-details mt-3">
          <h1 class="fs-4">Welcome back, {{ driver.name }}!</h1>
          <p class="mb-0">{{ driver.vehicle_type }} Driver â€¢ Plate No. {{ driver.vehicle_plate_number }}</p>
        </div>
      </div>
      <div class="status-badge">âœ… Verified</div>
      <div class="text-center">
        {% if driver.is_available %}
        <button class="toggle-button online" id="toggleButton" data-status="online">ðŸŸ¢ ONLINE</button>
        {% else %}
        <button class="toggle-button offline" id="toggleButton" data-status="offline">ðŸ”´ OFFLINE</button>
        {% endif %}
      </div>
    </div>

    <!-- Stats -->
    <div class="stats-grid">
      <div class="stat-card text-center">
        <div class="stat-icon fs-2 mb-2 text-primary">ðŸ“¦</div>
        <div class="stat-value fs-4 fw-bold">{{ total_deliveries }}</div>
        <div class="stat-label text-muted">Total Deliveries</div>
      </div>
      <div class="stat-card text-center">
        <div class="stat-icon fs-2 mb-2 text-success">ðŸ’°</div>
        <div class="stat-value fs-4 fw-bold">â‚±{{ total_earnings }}</div>
        <div class="stat-label text-muted">Total Earnings</div>
      </div>
    </div>

    <!-- Special Requests Table -->
    <div class="tables-container">
      <h2 class="h5 mb-3 border-bottom pb-2">ðŸ“‹ Special Requests</h2>
      <div class="table-responsive">
        <table class="table table-bordered align-middle text-center">
          <thead class="table-light">
            <tr>
              <th>Request ID</th>
              <th>Date</th>
              <th>Time</th>
              <th>Customer</th>
              <th>Contact</th>
              <th>Store</th>
              <th>Status</th>
              <th>Tip</th>
              <th>Accepted By</th>
              <th>View</th>
            </tr>
          </thead>
          <tbody>
            {% for request in special_requests %}
            <tr>
              <td>{{ request.id }}</td>
              <td>{{ request.date_requested }}</td>
              <td>{{ request.time_requested }}</td>
              <td>{{ request.customer_name }}</td>
              <td>{{ request.customer_phone_number }}</td>
              <td>{{ request.store }}</td>
              <td>{{ request.status }}</td>
              <td>â‚±{{ request.tip }}</td>
              <td>{{ request.driver.name }}</td>
              <td>
                {% if request.status != "Cancelled" and request.status != "Delivered" and request.status != "Undelivered" %}
                <a href="{% url 'special_request_detail' request.id %}" class="btn btn-sm btn-primary rounded-pill">View</a>
                {% else %}
                <button class="btn btn-sm btn-secondary rounded-pill" disabled>View</button>
                {% endif %}
              </td>
            </tr>
            {% empty %}
            <tr><td colspan="10">No special requests.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Recent Orders Table -->
    <div class="tables-container">
      <h2 class="h5 mb-3 border-bottom pb-2">ðŸ›’ Recent Orders</h2>
      <div class="table-responsive">
        <table class="table table-bordered align-middle text-center">
          <thead class="table-light">
            <tr>
              <th>Order ID</th>
              <th>Order Date</th>
              <th>Status</th>
              <th>Store</th>
              <th>Customer</th>
              <th>Contact No.</th>
              <th>Total Price</th>
              <th>Map</th>
              <th>Orders</th>
            </tr>
          </thead>
          <tbody>
            {% for order in recent_orders %}
            <tr>
              <td>{{ order.id }}</td>
              <td>{{ order.created_at }}</td>
              <td>{{ order.get_status_display }}</td>
              <td>{{ order.store.name }}</td>
              <td>{{ order.customer_name }}</td>
              <td>{{ order.customer_phone_number }}</td>
              <td>â‚±{{ order.total_price }}</td>
              <td><button class="btn btn-sm btn-outline-primary" onclick="openGoogleMaps('{{ order.customer_location }}')">Map</button></td>
              <td><a href="/order/{{ order.id }}/items_driver" class="btn btn-sm btn-success">View</a></td>
            </tr>
            {% empty %}
            <tr><td colspan="9">No recent orders.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- All Orders Table -->
    <div class="tables-container">
      <h2 class="h5 mb-3 border-bottom pb-2">ðŸ“¦ All Orders</h2>
      <div class="table-responsive">
        <table class="table table-bordered align-middle text-center">
          <thead class="table-light">
            <tr>
              <th>Order ID</th>
              <th>Order Date</th>
              <th>Status</th>
              <th>Store</th>
              <th>Total Price</th>
            </tr>
          </thead>
          <tbody>
            {% for order_all in orders_all %}
            <tr>
              <td>{{ order_all.id }}</td>
              <td>{{ order_all.created_at }}</td>
              <td>{{ order_all.get_status_display }}</td>
              <td>{{ order_all.store.name }}</td>
              <td>â‚±{{ order_all.total_price }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="5">No orders available.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Logout -->
    <form action="{% url 'logout' %}" method="POST">
      {% csrf_token %}
      <button type="submit" class="logout-btn">Logout</button>
    </form>
  </div>
  
  <audio id="notificationSound" src="/static/sounds/notification.mp3" type="audio/mpeg" type="audio/mpeg" preload="auto"></audio>

  
  <script>
    document.getElementById("toggleButton").addEventListener("click", function () {
      var currentStatus = this.getAttribute("data-status");
      var newStatus = currentStatus === "online" ? "offline" : "online";
      var button = document.getElementById("toggleButton");

      if (newStatus === "online") {
        button.textContent = "ðŸŸ¢ ONLINE";
        button.classList.remove("offline");
        button.classList.add("online");
      } else {
        button.textContent = "ðŸ”´ OFFLINE";
        button.classList.remove("online");
        button.classList.add("offline");
      }

      this.setAttribute("data-status", newStatus);

      fetch("{% url 'update_driver_status' %}", {
        method: "POST",
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
          'driver_id': {{ driver.id }},
          'is_available': newStatus === "online"
        })
      });
    });

    function openGoogleMaps(destination) {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function (position) {
          const mapsUrl = `https://www.google.com/maps/dir/?api=1&origin=${position.coords.latitude},${position.coords.longitude}&destination=${encodeURIComponent(destination)}`;
          window.open(mapsUrl, '_blank');
        }, function () {
          alert("Unable to retrieve your location.");
        });
      } else {
        alert("Geolocation is not supported by your browser.");
      }
    }
  </script>

  <script>
  let lastDataHash = '';

  function hashData(data) {
    return JSON.stringify(data); // Simple hash (can improve with hash libs)
  }

  function refreshTablesIfNeeded(newData) {
    const newHash = hashData(newData);
    if (newHash !== lastDataHash) {
      lastDataHash = newHash;

      // Play sound
      const sound = document.getElementById("notificationSound");
      if (sound) {
        sound.play().catch(err => console.error("Audio play error:", err));
      }

      // Show alert popup
      // alert("Alert!");

      // Optional: Visual notification
    showNotification("ðŸ””Checking...");

      // Reload page or update content
      location.reload(); // You can replace this with more granular update logic if needed
    }
  }

  function showNotification(message) {
    const notif = document.createElement("div");
    notif.className = "position-fixed top-0 start-50 translate-middle-x bg-warning text-dark p-3 rounded shadow";
    notif.style.zIndex = 1050;
    notif.textContent = message;

    document.body.appendChild(notif);
    setTimeout(() => notif.remove(), 4000);
  }

  function fetchUpdates() {
    fetch("{% url 'driver_updates' driver.id %}")
      .then(response => response.json())
      .then(data => {
        refreshTablesIfNeeded(data);
      })
      .catch(err => console.error('Update check failed:', err));
  }

  setInterval(fetchUpdates, 5000); // check every 15 seconds
</script>



</body>
</html>
