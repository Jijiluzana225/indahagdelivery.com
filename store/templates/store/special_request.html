{% extends "store/base.html" %}

{% block content %}
<div class="container mt-4">
  <h2>Special Request</h2>
  <form method="post">
    {% csrf_token %}
    {{ form.as_p }}
    
    <div class="row mt-4">
      <div class="col-md-6">
        <p><strong>Your location:</strong> {{ customer_location }}</p>
        <p><strong>Flat Rate Fee (applied automatically):</strong> â‚±{{ flat_rate_fee }}</p>
      </div>
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h5>Your Location on Map</h5>
          </div>
          <div class="card-body p-0">
            <div id="map" style="height: 300px; width: 100%;"></div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="mt-3">
      <button class="btn btn-primary" type="submit">Submit Request</button>
    </div>
  </form>
</div>

<script>
let map;
let geocoder;
let marker;

function initMap() {
    // Initialize the map centered on Manila
    map = new google.maps.Map(document.getElementById("map"), {
        zoom: 13,
        center: { lat: 14.5995, lng: 120.9842 }, // Manila coordinates
    });
    
    geocoder = new google.maps.Geocoder();
    
    // Get customer location from Django template
    const customerLocation = "{{ customer_location|escapejs }}";
    
    if (customerLocation && customerLocation.trim() !== '') {
        geocodeAddress(customerLocation);
    } else {
        // If no specific location, try to get user's current location
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const pos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                    };
                    
                    map.setCenter(pos);
                    addMarker(pos, "Your Current Location");
                },
                () => {
                    console.log("Geolocation failed, using default Manila location");
                }
            );
        }
    }
}

function geocodeAddress(address) {
    // Add "Philippines" to the address for better geocoding results
    const fullAddress = address.includes("Philippines") ? address : address + ", Philippines";
    
    geocoder.geocode({ address: fullAddress }, (results, status) => {
        if (status === "OK") {
            const location = results[0].geometry.location;
            map.setCenter(location);
            addMarker(location, address);
        } else {
            console.log("Geocoding failed: " + status);
            // Fallback: try without "Philippines" suffix
            if (fullAddress !== address) {
                geocoder.geocode({ address: address }, (results, status) => {
                    if (status === "OK") {
                        const location = results[0].geometry.location;
                        map.setCenter(location);
                        addMarker(location, address);
                    } else {
                        console.log("Geocoding failed again: " + status);
                    }
                });
            }
        }
    });
}

function addMarker(position, title) {
    // Remove existing marker if any
    if (marker) {
        marker.setMap(null);
    }
    
    // Add new marker
    marker = new google.maps.Marker({
        position: position,
        map: map,
        title: title,
        icon: {
            url: "https://maps.google.com/mapfiles/ms/icons/red-dot.png",
            scaledSize: new google.maps.Size(40, 40)
        }
    });
    
    // Add info window
    const infoWindow = new google.maps.InfoWindow({
        content: `<div style="padding: 5px;"><strong>${title}</strong></div>`
    });
    
    marker.addListener("click", () => {
        infoWindow.open(map, marker);
    });
}

// Initialize map when page loads
window.onload = function() {
    initMap();
};
</script>

<!-- Google Maps API Script -->
<script async defer 
    src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&callback=initMap">
</script>
{% endblock %}