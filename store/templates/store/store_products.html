{% extends 'store/base.html' %}

{% block title %}Order from {{ store.name }}{% endblock %}

{% block content %}

<style>
    /* General Styles */
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f4f4f9;
        color: #333;
        display: flex;
        justify-content: center;
    }

    .container {
        display: flex;
        flex-wrap: wrap;
        justify-content: center; /* Center horizontally */
        gap: 20px;
        padding: 20px;
        max-width: 1200px; /* Ensure container doesn't stretch too wide */
        width: 100%;
    }

    .left-column {
        flex: 1 1 70%;
        padding: 20px;
    }

    .right-column {
        flex: 1 1 30%;
        background-color: #f0f8ff;
        border-left: 1px solid #ddd;
        padding: 20px;
        position: sticky;
        top: 20px;
        height: calc(100vh - 40px);
        z-index: 10;
        box-shadow: -4px 0 10px rgba(0, 0, 0, 0.1);
        overflow-y: auto;
    }

    h1 {
        color: #333;
        font-size: 2rem;
        text-align: center;
    }

    p {
        font-size: 1rem;
        color: #666;
        text-align: center;
    }

    /* Product card styles */
    .product-card {
        background-color: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        text-align: center;
        padding: 15px;
        width: 100%;
        max-width: 300px;
        margin: 10px;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .product-card:hover {
        transform: scale(1.05);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
    }

    .product-card img {
        width: 120px;
        height: 120px;
        margin-bottom: 10px;
        border-radius: 8px;
    }

    .product-card input[type="number"] {
        width: 60px;
        padding: 5px;
        margin-bottom: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        text-align: center;
    }

    .product-card button {
        background-color: #28a745;
        color: #fff;
        padding: 10px;
        font-size: 0.9rem;
        border-radius: 5px;
        cursor: pointer;
        border: none;
        transition: background-color 0.3s ease;
    }

    .product-card button:hover {
        background-color: #218838;
    }

    .cart-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #fff;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 5px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .cart-item p {
        margin: 0;
        font-size: 0.9rem;
    }

    .cart-item input[type="number"] {
        width: 50px;
        padding: 5px;
        margin: 0 10px;
    }

    .cart-item button {
        background-color: #dc3545;
        color: #fff;
        padding: 5px;
        border-radius: 5px;
        cursor: pointer;
        border: none;
        font-size: 0.8rem;
    }

    .cart-item button:hover {
        background-color: #c82333;
    }

    .cart-total {
        font-weight: bold;
        font-size: 2rem;
        color: #333;
        margin-top: 20px;
    }

    .order-button {
        background-color: #007bff;
        color: white;
        padding: 12px;
        font-size: 1.2rem;
        border-radius: 8px;
        border: none;
        margin-top: 20px;
        width: 100%;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    .order-button:hover {
        background-color: #0056b3;
    }

    .order-button:disabled {
        background-color: #ddd;
        cursor: not-allowed;
    }

    /* Additional Instructions Styles */
    .additional-instructions {
        margin-top: 20px;
        font-size: 1rem;
    }

    .additional-instructions label {
        display: block;
        font-weight: bold;
        margin-bottom: 10px;
    }

    .additional-instructions textarea {
        width: 100%;
        height: 100px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 1rem;
        resize: vertical;
    }

    /* Money Input Box Styles */
    .money-input {
        margin-top: 20px;
        font-size: 1rem;
    }

    .money-input label {
        display: block;
        font-weight: bold;
        margin-bottom: 10px;
    }

    .money-input input {
        width: 40%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 1rem;
    }

    .money-input small {
        font-size: 0.9rem;
        color: #666;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .container {
            flex-direction: column;
            padding: 10px;
        }

        .left-column, .right-column {
            flex: 1 1 100%;
            padding: 10px;
        }

        .product-card {
            max-width: 100%;
            margin: 10px auto;
        }
    }

    @media (max-width: 480px) {
        h1 {
            font-size: 1.5rem;
        }

        .product-card {
            padding: 10px;
        }

        .cart-item {
            font-size: 0.8rem;
        }
    }
</style>

<div class="container">
    <div class="left-column">
        <h1>{{ store.name }}</h1>    
        <p>Contact: {{ store.contact_number }}</p>

        <div class="products">
            {% for item in items %}
            <div class="product-card">
                <img src="{{ item.product.picture.url }}" alt="{{ item.product.name }}">
                <h3>{{ item.product.name }}</h3>
                <p>{{ item.product.description }}</p>
                <p>Price: <span class="formatted-price">{{ item.product.price }}</span></p>
                <label for="quantity-{{ item.id }}">Qty:</label>
                <input type="number" id="quantity-{{ item.id }}" name="quantity" min="1" value="1">
                <button onclick="addToCart({{ item.id }}, '{{ item.product.name }}', {{ item.product.price }})">Add to Cart</button>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Right column (cart) -->
    <div class="right-column">
        <h2>Your Cart</h2>
        <div class="cart-items" id="cart-items"></div>
        <div class="cart-total" id="cart-total">Total: 0.00</div>

        <div class="money-input">
            <label for="money">Money</label>
            <input type="number" id="money" name="money" min="0">
            <small>For change purposes.</small>
        </div>

        <!-- Additional Instructions Section -->
        <div class="additional-instructions">
            <label for="additional-instructions">Additional Instructions</label>
            <textarea id="additional-instructions" placeholder="Enter any additional instructions for your order"></textarea>
        </div>

        <!-- Order Now Button -->
        <button class="order-button" id="orderButton" onclick="proceedToCheckout()" disabled>Order Now</button>
    </div>
</div>

<script>
    let cart = [];

    function formatPrice(price) {
        return new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(price);
    }

    function addToCart(itemId, itemName, itemPrice) {
        const quantity = parseInt(document.getElementById(`quantity-${itemId}`).value);
        const existingItem = cart.find(item => item.id === itemId);

        if (existingItem) {
            existingItem.quantity += quantity;
        } else {
            cart.push({ id: itemId, name: itemName, price: itemPrice, quantity: quantity });
        }

        renderCart();
    }

    function updateCartItem(itemId, newQuantity) {
        const item = cart.find(item => item.id === itemId);
        if (item) {
            item.quantity = newQuantity;
            renderCart();
        }
    }

    function deleteCartItem(itemId) {
        cart = cart.filter(item => item.id !== itemId);
        renderCart();
    }

    function renderCart() {
        const cartItemsContainer = document.getElementById('cart-items');
        const cartTotal = document.getElementById('cart-total');
        const orderButton = document.getElementById('orderButton');
        cartItemsContainer.innerHTML = '';
        let total = 0;

        cart.forEach(item => {
            const itemTotal = item.price * item.quantity;
            total += itemTotal;

            cartItemsContainer.innerHTML += `
                <div class="cart-item">
                    <p>${item.name}</p>
                    <input type="number" min="1" value="${item.quantity}" onchange="updateCartItem(${item.id}, this.value)">
                    <p>${formatPrice(itemTotal)}</p>
                    <button onclick="deleteCartItem(${item.id})">Ã—</button>
                </div>
            `;
        });

        cartTotal.innerText = `Total: ${formatPrice(total)}`;

        // Enable the "Order Now" button only if the cart is not empty
        orderButton.disabled = cart.length === 0;
    }

    function calculateTotalPrice() {
        return cart.reduce((total, item) => total + item.price * item.quantity, 0);
    }

    function proceedToCheckout() {
        const storeId = '{{ store.id }}';  // Assuming store.id is available
        const totalPrice = calculateTotalPrice();  // Total price from cart
        const cartItems = cart.map(item => `${item.name},${item.price},${item.quantity}`).join("|");
    
        // Make the POST request
        fetch('/checkout/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'  // CSRF token
            },
            body: `store_id=${storeId}&total_price=${totalPrice}&cart_items=${cartItems}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Order placed successfully!');
                window.location.href = '/dashboard' ;
            } else {
                alert('There was an error placing your order.');
            }
        })
        .catch(error => console.error('Error:', error));
    }
    

    function updateOrderStatus(orderId, status) {
        fetch(`/update_order_status/${orderId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ status: status })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Order status updated');
            } else {
                alert('Failed to update status');
            }
        });
    }


    
</script>

{% endblock %}
